{
  "files": [
    {
      "id": "a7250ec6-7913-4e9c-8efc-c63a156d2eb3",
      "name": "appsscript",
      "type": "json",
      "source": "{\n  \"timeZone\": \"America/Bogota\",\n  \"dependencies\": {\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"
    },
    {
      "id": "de022e78-62e2-4357-8530-d60cfae7f9e8",
      "name": "Code",
      "type": "server_js",
      "source": "var ss = SpreadsheetApp.getActiveSpreadsheet();\r\n\r\nfunction onOpen(){\r\n   var ui = SpreadsheetApp.getUi();\r\n    ui.createMenu('APP')\r\n        .addItem('Editar con formato', 'editarExtras')\r\n        .addToUi();     \r\n}\r\n\r\nfunction editarExtras() {\r\n  let row = ss.getActiveCell().getRow();\r\n  let col = ss.getActiveCell().getColumn();\r\n\r\n  let value = ss.getCurrentCell().getValue();\r\n  var title = ss.getActiveSheet().getRange(row,1).getValue();\r\n\r\n  if(!value.includes('±\\n') && value != '') { Browser.msgBox('La celda tiene formato incorrecto o está protegida'); return; }\r\n  if(value == '') value = '±\\n±\\n±\\n±\\n±\\n';\r\n  setUserProperties(['row', 'col', 'value'],[row, col, value]);\r\n  var arregloSeccion = value.split('±\\n');\r\n\r\n  // if(arregloSeccion[0] == '') arregloSeccion = [];\r\n  // while(arregloSeccion.length < 8){\r\n  //   let newRow = '»»';\r\n  //   arregloSeccion.push(newRow);\r\n  // }\r\n\r\n  arregloSeccion = arregloSeccion.map((entry, index) => {\r\n    if(!entry) entry = ' » »';\r\n    let arr = entry.split(' »');\r\n    let newObj = {};\r\n    newObj[`fecha^${index}`] = arr[0];\r\n    newObj[`agente~${index}`] = arr[1];\r\n    newObj[`comentario~${index}`] = arr[2];\r\n\r\n    return newObj;\r\n  });\r\n\r\n  var html = HtmlService.createTemplateFromFile('Blank');\r\n  var page = html.evaluate();\r\n\r\n  let indices = ['fecha^', 'agente~', 'comentario~'];\r\n  let interfaces = ['FECHA', 'AGENTE', 'COMENTARIO'];\r\n  let tamanoColumnas12 = [2,2,8];\r\n\r\n  page.append('<form class=\"text-center\" id=\"infoForm\" onsubmit=\"return validarForm(this)\" style=\"margin:10px;\">');\r\n  page.append('<input type=\"hidden\" id=\"tipo\" name=\"tipo\"  value=\"editar\">');\r\n  arregloSeccion.map(\r\n    (item, index) =>  page.append(getInputFilaForm(indices, item, interfaces, tamanoColumnas12, index))\r\n  )\r\n  page.append('<button type=\"submit\" class=\"btn btn-primary my-2\">GUARDAR</button>');\r\n  page.append('</form>');\r\n  \r\n  page.addMetaTag('viewport', 'width=device-width, initial-scale=1');\r\n  page.setWidth(1000).setHeight(350);\r\n  SpreadsheetApp.getUi().showModalDialog(page, 'Editar '+title);\r\n}\r\n\r\nfunction getInputFilaForm(indexesWithType, objetoFila, tablaTitles, colTamanos,j){\r\n  let ret = `<div class=\"form-floating m-2 requires-validation\" novalidate style=\"margin:1\">\r\n              <div class=\"row\">`;\r\n\r\n  indexesWithType.forEach((index, i) => {\r\n      var event = '';\r\n      var patternAttr = '', titleAttr = '', invalidFeedback = '', requiredAttr = '';\r\n      // index = index + i;\r\n      index = index + j\r\n\r\n      if( index.includes('^') ){\r\n        var type = 'date';\r\n        event = '';\r\n        // objetoFila[index] = objetoFila[index].split('T')[0].toString();\r\n        let x= '';\r\n      }else if( index.includes('#') ){\r\n        event = 'puntos(this);toggleInvalid(this)';\r\n        var type = 'text';\r\n        // objetoFila[index] = setDotSeparator(objetoFila[index]);\r\n      }else if( index.includes('~') ){\r\n        event = '';\r\n        if(index=='nombre~'){\r\n          patternAttr  = 'pattern=\"^[A-Za-z\\\\s]+$\"';\r\n          titleAttr = 'title=\"Solo letras o espacios sin caracteres especiales\"';\r\n        }\r\n        var type = 'text';\r\n      }else if( index.includes('%') ){\r\n        event = 'porcentaje(this)';\r\n        var type = 'text';\r\n        objetoFila[index] *= 100;\r\n        objetoFila[index] += '%';\r\n      }else if( index.includes('&') ){\r\n        event = '';\r\n        requiredAttr = 'disabled';\r\n        var type = 'text';\r\n      }\r\n      ret +=    `<div class=\"col-${colTamanos[i]}\">\r\n                  <input \r\n                    type=\"${type}\" \r\n                    class=\"form-control\" \r\n                    onkeyup=\"${event}\" \r\n                    placeholder=\"${tablaTitles[i]}\" \r\n                    id=\"${index}\" \r\n                    name=\"${index}\" \r\n                    value=\"${objetoFila[index]}\"\r\n                    ${patternAttr}\r\n                    ${titleAttr}\r\n                    ${requiredAttr}\r\n                    aria-label=\"${tablaTitles[i]}\">\r\n                  ${invalidFeedback}\r\n                </div>`;\r\n    });\r\n      ret +=  `</div>\r\n            </div>`;\r\n  return ret;\r\n}\r\n\r\nfunction setDotSeparator(number){\r\n  return number.toString().replace(/\\D/g, \"\").replace(/\\B(?=(\\d{3})+(?!\\d)\\.?)/g, \".\");\r\n}\r\n\r\nfunction validarForm(formObject){\r\n  switch(formObject.tipo){\r\n    case 'editar':\r\n      formExtras(formObject);\r\n      break;\r\n\r\n    default:\r\n      return;\r\n  }\r\n}\r\n\r\n\r\nfunction formExtras(formObject){\r\n  showLoadingDialog();\r\n  \r\n  // try{\r\n    var form = JSON.parse(JSON.stringify(formObject));\r\n    var [row, col, value] = getUserProperties(['row','col','value']);\r\n\r\n    value = value.split('±\\n');\r\n    for(let i = 0; i < 5; i++){\r\n      let entry = `${form['fecha^'+i]} »${form['agente~'+i]} »${form['comentario~'+i]}`;\r\n      // if(entry != ' » »')\r\n        value[i] = entry;\r\n      // else\r\n      //   value[i] = '';\r\n    }\r\n    value = value.join('±\\n');\r\n\r\n    ss.getActiveSheet().getRange(row,col).setValue(value);\r\n\r\n    closeLoadingDialog('Edición');\r\n  // } catch(error){ \r\n  //   showErrorDialog(error); \r\n  //   console.error(error);\r\n  //   console.error(error.stack);\r\n  //   throw error;\r\n  // }\r\n}\r\n\r\nfunction getUserProperties(keys){\r\n  var userProperties = PropertiesService.getUserProperties();\r\n  var propertiesValues = [];\r\n  keys.map(\r\n    (key) => {\r\n      propertiesValues.push(JSON.parse(userProperties.getProperty(key)))\r\n    }\r\n  )\r\n  return propertiesValues;\r\n}\r\nfunction setUserProperties( keys, values){\r\n  var userProperties = PropertiesService.getUserProperties();\r\n  keys.map(\r\n    (key, index) => {\r\n      userProperties.setProperty(key, JSON.stringify(values[index]));\r\n    }\r\n  );\r\n}\r\n\r\n//------------------------------------- showDialog -----------------------------------------\r\nfunction showLoadingDialog(action) {\r\n  var htmlOutput = HtmlService\r\n    .createHtmlOutput()\r\n    .setWidth(300)\r\n    .setHeight(300);\r\n  SpreadsheetApp.getUi().showModalDialog(htmlOutput, !action ? 'Cargando...' : action);\r\n}\r\nfunction closeLoadingDialog(action){\r\n  var htmlOutput = HtmlService\r\n    .createHtmlOutput('<script>google.script.host.close();</script>')\r\n    .setWidth(300)\r\n    .setHeight(300);\r\n  SpreadsheetApp.getUi().showModalDialog(htmlOutput, action);\r\n}\r\nfunction showErrorDialog(errorMessage){\r\n  var htmlOutput = HtmlService\r\n    .createHtmlOutput(`<div style=\"text-align: center; font-family: monospace;\">${errorMessage}</div>`)\r\n    .setWidth(300)\r\n    .setHeight(300);\r\n  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'Error');\r\n  // console.error(errorMessage.stack);\r\n}"
    },
    {
      "id": "2018b35c-efd7-4ceb-8a21-9646e93981b1",
      "name": "Blank",
      "type": "html",
      "source": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC\" crossorigin=\"anonymous\">\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js\" integrity=\"sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM\" crossorigin=\"anonymous\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js\" integrity=\"sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p\" crossorigin=\"anonymous\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js\" integrity=\"sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF\" crossorigin=\"anonymous\"></script>    \n    <title>Document</title>\n</head>\n<body>\n  <div class=\"container\">\n    <!-- Here the html will be generated automatically from editar-info.gs file -->\n  </div>\n  <script src=\"//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js\">\n  </script>\n  <script>\n\n    function validarForm(form){\n      $('button').attr('disabled', true);\n      google.script.run.withFailureHandler(onFailure).validarForm(form);\n      return false;\n    }\n    function onFailure(error){\n      var elementId = error.message.split('Error: ')[1].replace('#','\\\\#');\n      $('#'+elementId).addClass('is-invalid');\n      $('#'+elementId).trigger('focus');\n    }\n    function toggleInvalid(input){\n      var elementId = input.id.replace('#','\\\\#');\n      $('#'+elementId).removeClass('is-invalid');\n      $('button').attr('disabled', false);\n    }\n    function changeCheckbox(input){\n      input.value = input.checked;\n    }\n    function puntos(input){\n      var newValue = input.value.replace(/\\D/g, \"\")\n                                .replace(/\\B(?=(\\d{3})+(?!\\d)\\.?)/g, \".\");\n      input.value = newValue;\n    }\n    function porcentaje(input){\n      var newValue = input.value;\n      newValue = newValue[0].replace(/[^0-9-]/,'') \n                + newValue.slice(1).replace(/\\D/g, '');\n      newValue = (newValue != '') ? newValue.concat('%') : newValue;                              \n      input.value = newValue;\n      const setCaretPosition = (elem, caretPos) => {\n        if (elem !== null) {\n          if (elem.createTextRange) {\n            const range = elem.createTextRange();\n            range.move('character', caretPos);\n            range.select();\n          } else {\n            if (elem.selectionStart) {\n              elem.focus();\n              elem.setSelectionRange(caretPos, caretPos);\n            } else\n              elem.focus();\n          }\n        }\n      }\n      setCaretPosition(input, Math.max(input.value.length-1, 0));\n    }\n  </script>\n</body>\n</html>"
    }
  ]
}
